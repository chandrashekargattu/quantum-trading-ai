<!DOCTYPE html>
<html>
<head>
    <title>Debug Authentication - Quantum Trading AI</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { margin: 5px; padding: 10px 20px; cursor: pointer; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>üîç Debug Authentication</h1>
    
    <div class="section">
        <h2>Current Authentication State</h2>
        <div id="authState"></div>
    </div>
    
    <div class="section">
        <h2>Quick Actions</h2>
        <button onclick="clearAll()">üóëÔ∏è Clear All Data</button>
        <button onclick="testLogin()">üîê Test Login</button>
        <button onclick="checkDashboard()">üìä Check Dashboard Access</button>
        <button onclick="setTestToken()">üé´ Set Test Token</button>
    </div>
    
    <div class="section">
        <h2>Manual Login</h2>
        <input type="email" id="email" placeholder="Email" value="chandrashekargattu@gmail.com" style="width: 300px; padding: 8px;">
        <br><br>
        <input type="password" id="password" placeholder="Password" style="width: 300px; padding: 8px;">
        <br><br>
        <button onclick="manualLogin()">Login</button>
    </div>
    
    <div class="section">
        <h2>Results</h2>
        <div id="results"></div>
    </div>
    
    <script>
        function updateAuthState() {
            const token = localStorage.getItem('access_token');
            const tokenType = localStorage.getItem('token_type');
            const user = localStorage.getItem('user');
            
            let html = '<h3>LocalStorage:</h3>';
            html += `<p class="${token ? 'success' : 'error'}">Token: ${token ? '‚úÖ Present (' + token.substring(0, 20) + '...)' : '‚ùå Missing'}</p>`;
            html += `<p class="${tokenType ? 'success' : 'info'}">Token Type: ${tokenType || 'Not set'}</p>`;
            html += `<p class="${user ? 'success' : 'info'}">User Data: ${user ? '‚úÖ Present' : '‚ùå Missing'}</p>`;
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    html += '<pre>' + JSON.stringify(userData, null, 2) + '</pre>';
                } catch (e) {
                    html += '<p class="error">Error parsing user data</p>';
                }
            }
            
            document.getElementById('authState').innerHTML = html;
        }
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const time = new Date().toLocaleTimeString();
            results.innerHTML = `<p class="${type}">[${time}] ${message}</p>` + results.innerHTML;
        }
        
        function clearAll() {
            localStorage.clear();
            log('‚úÖ Cleared all localStorage data', 'success');
            updateAuthState();
        }
        
        async function testLogin() {
            try {
                log('Testing login with testuser...');
                
                const response = await fetch('http://localhost:8000/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        username: 'testuser',
                        password: 'TestPass123',
                    }),
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('token_type', data.token_type);
                    log('‚úÖ Test login successful!', 'success');
                    updateAuthState();
                } else {
                    const error = await response.json();
                    log('‚ùå Login failed: ' + (error.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('‚ùå Network error: ' + error.message, 'error');
            }
        }
        
        async function manualLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                log('‚ùå Please enter both email and password', 'error');
                return;
            }
            
            try {
                log(`Attempting login for: ${email}`);
                
                const response = await fetch('http://localhost:8000/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        username: email,
                        password: password,
                    }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('token_type', data.token_type);
                    log('‚úÖ Login successful! Token saved.', 'success');
                    
                    // Try to fetch user data
                    const userResponse = await fetch('http://localhost:8000/api/v1/users/me', {
                        headers: {
                            'Authorization': `${data.token_type} ${data.access_token}`
                        }
                    });
                    
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        localStorage.setItem('user', JSON.stringify(userData));
                        log('‚úÖ User data fetched and saved', 'success');
                    }
                    
                    updateAuthState();
                } else {
                    log('‚ùå Login failed: ' + (data.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        async function checkDashboard() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                log('‚ùå No token found. Please login first.', 'error');
                return;
            }
            
            log('Checking dashboard access...');
            
            // Open dashboard in new tab
            window.open('http://localhost:3000/dashboard', '_blank');
            log('‚úÖ Opened dashboard in new tab. Check if it loads correctly.', 'success');
        }
        
        function setTestToken() {
            // This is a dummy token for testing
            const testToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IlRlc3QgVXNlciIsImlhdCI6MTUxNjIzOTAyMn0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c';
            localStorage.setItem('access_token', testToken);
            localStorage.setItem('token_type', 'bearer');
            log('‚úÖ Set test token (Note: This won\'t work with real API)', 'info');
            updateAuthState();
        }
        
        // Update state on load
        updateAuthState();
        
        // Clear URL parameters
        if (window.location.search) {
            window.history.replaceState({}, '', window.location.pathname);
        }
    </script>
</body>
</html>
